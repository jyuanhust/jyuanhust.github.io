<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="yuan" href="https://huang-junyuan.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="yuan" href="https://huang-junyuan.github.io/atom.xml"><link rel="alternate" type="application/json" title="yuan" href="https://huang-junyuan.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="chapter_natural-language-processing-pretraining"><link rel="canonical" href="https://huang-junyuan.github.io/2023/02/15/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter_natural-language-processing-pretraining/bert-dataset/"><title>bert-dataset - chapter_natural-language-processing-pretraining - pytorchæ·±åº¦å­¦ä¹  - ai | Mi Manchi = yuan = Whatever is worth doing at all is worth doing well</title><meta name="generator" content="Hexo 6.2.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">bert-dataset</h1><div class="meta"><span class="item" title="åˆ›å»ºæ—¶é—´ï¼š2023-02-15 00:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">å‘è¡¨äº</span> <time itemprop="dateCreated datePublished" datetime="2023-02-15T00:00:00+08:00">2023-02-15</time> </span><span class="item" title="æœ¬æ–‡å­—æ•°"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">æœ¬æ–‡å­—æ•°</span> <span>8.1k</span> <span class="text">å­—</span> </span><span class="item" title="é˜…è¯»æ—¶é•¿"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">é˜…è¯»æ—¶é•¿</span> <span>7 åˆ†é’Ÿ</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="åˆ‡æ¢å¯¼èˆªæ "><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Mi Manchi</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://gitee.com/zkz0/image/raw/master/img/img(23).webp"></li><li class="item" data-background-image="https://gitee.com/zkz0/image/raw/master/img/img(57).webp"></li><li class="item" data-background-image="https://gitee.com/zkz0/image/raw/master/img/img(65).webp"></li><li class="item" data-background-image="https://gitee.com/zkz0/image/raw/master/img/img(21).webp"></li><li class="item" data-background-image="https://gitee.com/zkz0/image/raw/master/img/img(89).webp"></li><li class="item" data-background-image="https://gitee.com/zkz0/image/raw/master/img/img(83).webp"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">é¦–é¡µ</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/ai/" itemprop="item" rel="index" title="åˆ†ç±»äº ai"><span itemprop="name">ai</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" itemprop="item" rel="index" title="åˆ†ç±»äº pytorchæ·±åº¦å­¦ä¹ "><span itemprop="name">pytorchæ·±åº¦å­¦ä¹ </span></a><meta itemprop="position" content="2"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter-natural-language-processing-pretraining/" itemprop="item" rel="index" title="åˆ†ç±»äº chapter_natural-language-processing-pretraining"><span itemprop="name">chapter_natural-language-processing-pretraining</span></a><meta itemprop="position" content="3"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://huang-junyuan.github.io/2023/02/15/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter_natural-language-processing-pretraining/bert-dataset/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="yuan"><meta itemprop="description" content="Whatever is worth doing at all is worth doing well, "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="yuan"></span><div class="body md" itemprop="articleBody"><h1 id="ç”¨äºé¢„è®­ç»ƒbertçš„æ•°æ®é›†"><a class="anchor" href="#ç”¨äºé¢„è®­ç»ƒbertçš„æ•°æ®é›†">#</a> ç”¨äºé¢„è®­ç»ƒ BERT çš„æ•°æ®é›†</h1><p>ğŸ· <code>sec_bert-dataset</code></p><p>ä¸ºäº†é¢„è®­ç»ƒ :numref: <code>sec_bert</code> ä¸­å®ç°çš„ BERT æ¨¡å‹ï¼Œæˆ‘ä»¬éœ€è¦ä»¥ç†æƒ³çš„æ ¼å¼ç”Ÿæˆæ•°æ®é›†ï¼Œä»¥ä¾¿äºä¸¤ä¸ªé¢„è®­ç»ƒä»»åŠ¡ï¼šé®è”½è¯­è¨€æ¨¡å‹å’Œä¸‹ä¸€å¥é¢„æµ‹ã€‚ä¸€æ–¹é¢ï¼Œæœ€åˆçš„ BERT æ¨¡å‹æ˜¯åœ¨ä¸¤ä¸ªåºå¤§çš„å›¾ä¹¦è¯­æ–™åº“å’Œè‹±è¯­ç»´åŸºç™¾ç§‘ï¼ˆå‚è§ :numref: <code>subsec_bert_pretraining_tasks</code> ï¼‰çš„åˆé›†ä¸Šé¢„è®­ç»ƒçš„ï¼Œä½†å®ƒå¾ˆéš¾å¸å¼•è¿™æœ¬ä¹¦çš„å¤§å¤šæ•°è¯»è€…ã€‚å¦ä¸€æ–¹é¢ï¼Œç°æˆçš„é¢„è®­ç»ƒ BERT æ¨¡å‹å¯èƒ½ä¸é€‚åˆåŒ»å­¦ç­‰ç‰¹å®šé¢†åŸŸçš„åº”ç”¨ã€‚å› æ­¤ï¼Œåœ¨å®šåˆ¶çš„æ•°æ®é›†ä¸Šå¯¹ BERT è¿›è¡Œé¢„è®­ç»ƒå˜å¾—è¶Šæ¥è¶Šæµè¡Œã€‚ä¸ºäº†æ–¹ä¾¿ BERT é¢„è®­ç»ƒçš„æ¼”ç¤ºï¼Œæˆ‘ä»¬ä½¿ç”¨äº†è¾ƒå°çš„è¯­æ–™åº“ WikiText-2 :cite: <code>Merity.Xiong.Bradbury.ea.2016</code> ã€‚</p><p>ä¸ :numref: <code>sec_word2vec_data</code> ä¸­ç”¨äºé¢„è®­ç»ƒ word2vec çš„ PTB æ•°æ®é›†ç›¸æ¯”ï¼ŒWikiText-2ï¼ˆ1ï¼‰ä¿ç•™äº†åŸæ¥çš„æ ‡ç‚¹ç¬¦å·ï¼Œé€‚åˆäºä¸‹ä¸€å¥é¢„æµ‹ï¼›ï¼ˆ2ï¼‰ä¿ç•™äº†åŸæ¥çš„å¤§å°å†™å’Œæ•°å­—ï¼›ï¼ˆ3ï¼‰å¤§äº†ä¸€å€ä»¥ä¸Šã€‚</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> os</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> random</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> torch</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">from</span> d2l <span class="token keyword">import</span> torch <span class="token keyword">as</span> d2l</pre></td></tr></table></figure><p>åœ¨ WikiText-2 æ•°æ®é›†ä¸­ï¼Œæ¯è¡Œä»£è¡¨ä¸€ä¸ªæ®µè½ï¼Œå…¶ä¸­åœ¨ä»»æ„æ ‡ç‚¹ç¬¦å·åŠå…¶å‰é¢çš„è¯å…ƒä¹‹é—´æ’å…¥ç©ºæ ¼ã€‚ä¿ç•™è‡³å°‘æœ‰ä¸¤å¥è¯çš„æ®µè½ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬ä»…ä½¿ç”¨å¥å·ä½œä¸ºåˆ†éš”ç¬¦æ¥æ‹†åˆ†å¥å­ã€‚æˆ‘ä»¬å°†æ›´å¤æ‚çš„å¥å­æ‹†åˆ†æŠ€æœ¯çš„è®¨è®ºç•™åœ¨æœ¬èŠ‚æœ«å°¾çš„ç»ƒä¹ ä¸­ã€‚</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#@save</span></pre></td></tr><tr><td data-num="2"></td><td><pre>d2l<span class="token punctuation">.</span>DATA_HUB<span class="token punctuation">[</span><span class="token string">'wikitext-2'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token string">'https://s3.amazonaws.com/research.metamind.io/wikitext/'</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token string">'wikitext-2-v1.zip'</span><span class="token punctuation">,</span> <span class="token string">'3c914d17d80b1459be871a5039ac23e752a53cbe'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#@save</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">def</span> <span class="token function">_read_wiki</span><span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    file_name <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> <span class="token string">'wiki.train.tokens'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        lines <span class="token operator">=</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment"># å¤§å†™å­—æ¯è½¬æ¢ä¸ºå°å†™å­—æ¯</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    paragraphs <span class="token operator">=</span> <span class="token punctuation">[</span>line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' . '</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                  <span class="token keyword">for</span> line <span class="token keyword">in</span> lines <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' . '</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>paragraphs<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">return</span> paragraphs</pre></td></tr></table></figure><h2 id="ä¸ºé¢„è®­ç»ƒä»»åŠ¡å®šä¹‰è¾…åŠ©å‡½æ•°"><a class="anchor" href="#ä¸ºé¢„è®­ç»ƒä»»åŠ¡å®šä¹‰è¾…åŠ©å‡½æ•°">#</a> ä¸ºé¢„è®­ç»ƒä»»åŠ¡å®šä¹‰è¾…åŠ©å‡½æ•°</h2><p>åœ¨ä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆä¸º BERT çš„ä¸¤ä¸ªé¢„è®­ç»ƒä»»åŠ¡å®ç°è¾…åŠ©å‡½æ•°ã€‚è¿™äº›è¾…åŠ©å‡½æ•°å°†åœ¨ç¨åå°†åŸå§‹æ–‡æœ¬è¯­æ–™åº“è½¬æ¢ä¸ºç†æƒ³æ ¼å¼çš„æ•°æ®é›†æ—¶è°ƒç”¨ï¼Œä»¥é¢„è®­ç»ƒ BERTã€‚</p><h3 id="ç”Ÿæˆä¸‹ä¸€å¥é¢„æµ‹ä»»åŠ¡çš„æ•°æ®"><a class="anchor" href="#ç”Ÿæˆä¸‹ä¸€å¥é¢„æµ‹ä»»åŠ¡çš„æ•°æ®">#</a> ç”Ÿæˆä¸‹ä¸€å¥é¢„æµ‹ä»»åŠ¡çš„æ•°æ®</h3><p>æ ¹æ® :numref: <code>subsec_nsp</code> çš„æè¿°ï¼Œ <code>_get_next_sentence</code> å‡½æ•°ç”ŸæˆäºŒåˆ†ç±»ä»»åŠ¡çš„è®­ç»ƒæ ·æœ¬ã€‚</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#@save</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">def</span> <span class="token function">_get_next_sentence</span><span class="token punctuation">(</span>sentence<span class="token punctuation">,</span> next_sentence<span class="token punctuation">,</span> paragraphs<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.5</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        is_next <span class="token operator">=</span> <span class="token boolean">True</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token comment"># paragraphs æ˜¯ä¸‰é‡åˆ—è¡¨çš„åµŒå¥—</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        next_sentence <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>paragraphs<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        is_next <span class="token operator">=</span> <span class="token boolean">False</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">return</span> sentence<span class="token punctuation">,</span> next_sentence<span class="token punctuation">,</span> is_next</pre></td></tr></table></figure><p>ä¸‹é¢çš„å‡½æ•°é€šè¿‡è°ƒç”¨ <code>_get_next_sentence</code> å‡½æ•°ä»è¾“å…¥ <code>paragraph</code> ç”Ÿæˆç”¨äºä¸‹ä¸€å¥é¢„æµ‹çš„è®­ç»ƒæ ·æœ¬ã€‚è¿™é‡Œ <code>paragraph</code> æ˜¯å¥å­åˆ—è¡¨ï¼Œå…¶ä¸­æ¯ä¸ªå¥å­éƒ½æ˜¯è¯å…ƒåˆ—è¡¨ã€‚è‡ªå˜é‡ <code>max_len</code> æŒ‡å®šé¢„è®­ç»ƒæœŸé—´çš„ BERT è¾“å…¥åºåˆ—çš„æœ€å¤§é•¿åº¦ã€‚</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#@save</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">def</span> <span class="token function">_get_nsp_data_from_paragraph</span><span class="token punctuation">(</span>paragraph<span class="token punctuation">,</span> paragraphs<span class="token punctuation">,</span> vocab<span class="token punctuation">,</span> max_len<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    nsp_data_from_paragraph <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>paragraph<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        tokens_a<span class="token punctuation">,</span> tokens_b<span class="token punctuation">,</span> is_next <span class="token operator">=</span> _get_next_sentence<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            paragraph<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> paragraph<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> paragraphs<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token comment"># è€ƒè™‘ 1 ä¸ª '&lt;cls>' è¯å…ƒå’Œ 2 ä¸ª '&lt;sep>' è¯å…ƒ</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tokens_a<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tokens_b<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">></span> max_len<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token keyword">continue</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        tokens<span class="token punctuation">,</span> segments <span class="token operator">=</span> d2l<span class="token punctuation">.</span>get_tokens_and_segments<span class="token punctuation">(</span>tokens_a<span class="token punctuation">,</span> tokens_b<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        nsp_data_from_paragraph<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>tokens<span class="token punctuation">,</span> segments<span class="token punctuation">,</span> is_next<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">return</span> nsp_data_from_paragraph</pre></td></tr></table></figure><h3 id="ç”Ÿæˆé®è”½è¯­è¨€æ¨¡å‹ä»»åŠ¡çš„æ•°æ®"><a class="anchor" href="#ç”Ÿæˆé®è”½è¯­è¨€æ¨¡å‹ä»»åŠ¡çš„æ•°æ®">#</a> ç”Ÿæˆé®è”½è¯­è¨€æ¨¡å‹ä»»åŠ¡çš„æ•°æ®</h3><p>ğŸ· <code>subsec_prepare_mlm_data</code></p><p>ä¸ºäº†ä» BERT è¾“å…¥åºåˆ—ç”Ÿæˆé®è”½è¯­è¨€æ¨¡å‹çš„è®­ç»ƒæ ·æœ¬ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä»¥ä¸‹ <code>_replace_mlm_tokens</code> å‡½æ•°ã€‚åœ¨å…¶è¾“å…¥ä¸­ï¼Œ <code>tokens</code> æ˜¯è¡¨ç¤º BERT è¾“å…¥åºåˆ—çš„è¯å…ƒçš„åˆ—è¡¨ï¼Œ <code>candidate_pred_positions</code> æ˜¯ä¸åŒ…æ‹¬ç‰¹æ®Šè¯å…ƒçš„ BERT è¾“å…¥åºåˆ—çš„è¯å…ƒç´¢å¼•çš„åˆ—è¡¨ï¼ˆç‰¹æ®Šè¯å…ƒåœ¨é®è”½è¯­è¨€æ¨¡å‹ä»»åŠ¡ä¸­ä¸è¢«é¢„æµ‹ï¼‰ï¼Œä»¥åŠ <code>num_mlm_preds</code> æŒ‡ç¤ºé¢„æµ‹çš„æ•°é‡ï¼ˆé€‰æ‹© 15% è¦é¢„æµ‹çš„éšæœºè¯å…ƒï¼‰ã€‚åœ¨ :numref: <code>subsec_mlm</code> ä¸­å®šä¹‰é®è”½è¯­è¨€æ¨¡å‹ä»»åŠ¡ä¹‹åï¼Œåœ¨æ¯ä¸ªé¢„æµ‹ä½ç½®ï¼Œè¾“å…¥å¯ä»¥ç”±ç‰¹æ®Šçš„ â€œæ©ç â€ è¯å…ƒæˆ–éšæœºè¯å…ƒæ›¿æ¢ï¼Œæˆ–è€…ä¿æŒä¸å˜ã€‚æœ€åï¼Œè¯¥å‡½æ•°è¿”å›å¯èƒ½æ›¿æ¢åçš„è¾“å…¥è¯å…ƒã€å‘ç”Ÿé¢„æµ‹çš„è¯å…ƒç´¢å¼•å’Œè¿™äº›é¢„æµ‹çš„æ ‡ç­¾ã€‚</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#@save</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">def</span> <span class="token function">_replace_mlm_tokens</span><span class="token punctuation">(</span>tokens<span class="token punctuation">,</span> candidate_pred_positions<span class="token punctuation">,</span> num_mlm_preds<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                        vocab<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment"># ä¸ºé®è”½è¯­è¨€æ¨¡å‹çš„è¾“å…¥åˆ›å»ºæ–°çš„è¯å…ƒå‰¯æœ¬ï¼Œå…¶ä¸­è¾“å…¥å¯èƒ½åŒ…å«æ›¿æ¢çš„ â€œ&lt;mask>â€ æˆ–éšæœºè¯å…ƒ</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    mlm_input_tokens <span class="token operator">=</span> <span class="token punctuation">[</span>token <span class="token keyword">for</span> token <span class="token keyword">in</span> tokens<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    pred_positions_and_labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment"># æ‰“ä¹±åç”¨äºåœ¨é®è”½è¯­è¨€æ¨¡å‹ä»»åŠ¡ä¸­è·å– 15% çš„éšæœºè¯å…ƒè¿›è¡Œé¢„æµ‹</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>candidate_pred_positions<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">for</span> mlm_pred_position <span class="token keyword">in</span> candidate_pred_positions<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pred_positions_and_labels<span class="token punctuation">)</span> <span class="token operator">>=</span> num_mlm_preds<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token keyword">break</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        masked_token <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment"># 80% çš„æ—¶é—´ï¼šå°†è¯æ›¿æ¢ä¸º â€œ&lt;mask>â€ è¯å…ƒ</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.8</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            masked_token <span class="token operator">=</span> <span class="token string">'&lt;mask>'</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token comment"># 10% çš„æ—¶é—´ï¼šä¿æŒè¯ä¸å˜</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token keyword">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.5</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                masked_token <span class="token operator">=</span> tokens<span class="token punctuation">[</span>mlm_pred_position<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token comment"># 10% çš„æ—¶é—´ï¼šç”¨éšæœºè¯æ›¿æ¢è¯¥è¯</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                masked_token <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>vocab<span class="token punctuation">.</span>idx_to_token<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        mlm_input_tokens<span class="token punctuation">[</span>mlm_pred_position<span class="token punctuation">]</span> <span class="token operator">=</span> masked_token</pre></td></tr><tr><td data-num="24"></td><td><pre>        pred_positions_and_labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token punctuation">(</span>mlm_pred_position<span class="token punctuation">,</span> tokens<span class="token punctuation">[</span>mlm_pred_position<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">return</span> mlm_input_tokens<span class="token punctuation">,</span> pred_positions_and_labels</pre></td></tr></table></figure><p>é€šè¿‡è°ƒç”¨å‰è¿°çš„ <code>_replace_mlm_tokens</code> å‡½æ•°ï¼Œä»¥ä¸‹å‡½æ•°å°† BERT è¾“å…¥åºåˆ—ï¼ˆ <code>tokens</code> ï¼‰ä½œä¸ºè¾“å…¥ï¼Œå¹¶è¿”å›è¾“å…¥è¯å…ƒçš„ç´¢å¼•ï¼ˆåœ¨ :numref: <code>subsec_mlm</code> ä¸­æè¿°çš„å¯èƒ½çš„è¯å…ƒæ›¿æ¢ä¹‹åï¼‰ã€å‘ç”Ÿé¢„æµ‹çš„è¯å…ƒç´¢å¼•ä»¥åŠè¿™äº›é¢„æµ‹çš„æ ‡ç­¾ç´¢å¼•ã€‚</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#@save</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">def</span> <span class="token function">_get_mlm_data_from_tokens</span><span class="token punctuation">(</span>tokens<span class="token punctuation">,</span> vocab<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    candidate_pred_positions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment"># tokens æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²åˆ—è¡¨</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">for</span> i<span class="token punctuation">,</span> token <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>tokens<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token comment"># åœ¨é®è”½è¯­è¨€æ¨¡å‹ä»»åŠ¡ä¸­ä¸ä¼šé¢„æµ‹ç‰¹æ®Šè¯å…ƒ</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">if</span> token <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'&lt;cls>'</span><span class="token punctuation">,</span> <span class="token string">'&lt;sep>'</span><span class="token punctuation">]</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token keyword">continue</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        candidate_pred_positions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment"># é®è”½è¯­è¨€æ¨¡å‹ä»»åŠ¡ä¸­é¢„æµ‹ 15% çš„éšæœºè¯å…ƒ</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    num_mlm_preds <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">round</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>tokens<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.15</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    mlm_input_tokens<span class="token punctuation">,</span> pred_positions_and_labels <span class="token operator">=</span> _replace_mlm_tokens<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        tokens<span class="token punctuation">,</span> candidate_pred_positions<span class="token punctuation">,</span> num_mlm_preds<span class="token punctuation">,</span> vocab<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    pred_positions_and_labels <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>pred_positions_and_labels<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                                       key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    pred_positions <span class="token operator">=</span> <span class="token punctuation">[</span>v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> v <span class="token keyword">in</span> pred_positions_and_labels<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    mlm_pred_labels <span class="token operator">=</span> <span class="token punctuation">[</span>v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> v <span class="token keyword">in</span> pred_positions_and_labels<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">return</span> vocab<span class="token punctuation">[</span>mlm_input_tokens<span class="token punctuation">]</span><span class="token punctuation">,</span> pred_positions<span class="token punctuation">,</span> vocab<span class="token punctuation">[</span>mlm_pred_labels<span class="token punctuation">]</span></pre></td></tr></table></figure><h2 id="å°†æ–‡æœ¬è½¬æ¢ä¸ºé¢„è®­ç»ƒæ•°æ®é›†"><a class="anchor" href="#å°†æ–‡æœ¬è½¬æ¢ä¸ºé¢„è®­ç»ƒæ•°æ®é›†">#</a> å°†æ–‡æœ¬è½¬æ¢ä¸ºé¢„è®­ç»ƒæ•°æ®é›†</h2><p>ç°åœ¨æˆ‘ä»¬å‡ ä¹å‡†å¤‡å¥½ä¸º BERT é¢„è®­ç»ƒå®šåˆ¶ä¸€ä¸ª <code>Dataset</code> ç±»ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦å®šä¹‰è¾…åŠ©å‡½æ•° <code>_pad_bert_inputs</code> æ¥å°†ç‰¹æ®Šçš„ â€œ&lt;mask&gt;â€ è¯å…ƒé™„åŠ åˆ°è¾“å…¥ã€‚å®ƒçš„å‚æ•° <code>examples</code> åŒ…å«æ¥è‡ªä¸¤ä¸ªé¢„è®­ç»ƒä»»åŠ¡çš„è¾…åŠ©å‡½æ•° <code>_get_nsp_data_from_paragraph</code> å’Œ <code>_get_mlm_data_from_tokens</code> çš„è¾“å‡ºã€‚</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#@save</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">def</span> <span class="token function">_pad_bert_inputs</span><span class="token punctuation">(</span>examples<span class="token punctuation">,</span> max_len<span class="token punctuation">,</span> vocab<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    max_num_mlm_preds <span class="token operator">=</span> <span class="token builtin">round</span><span class="token punctuation">(</span>max_len <span class="token operator">*</span> <span class="token number">0.15</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    all_token_ids<span class="token punctuation">,</span> all_segments<span class="token punctuation">,</span> valid_lens<span class="token punctuation">,</span>  <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    all_pred_positions<span class="token punctuation">,</span> all_mlm_weights<span class="token punctuation">,</span> all_mlm_labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    nsp_labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span>token_ids<span class="token punctuation">,</span> pred_positions<span class="token punctuation">,</span> mlm_pred_label_ids<span class="token punctuation">,</span> segments<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>         is_next<span class="token punctuation">)</span> <span class="token keyword">in</span> examples<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        all_token_ids<span class="token punctuation">.</span>append<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>token_ids <span class="token operator">+</span> <span class="token punctuation">[</span>vocab<span class="token punctuation">[</span><span class="token string">'&lt;pad>'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            max_len <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>token_ids<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        all_segments<span class="token punctuation">.</span>append<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>segments <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            max_len <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>segments<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment"># valid_lens ä¸åŒ…æ‹¬ '&lt;pad>' çš„è®¡æ•°</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        valid_lens<span class="token punctuation">.</span>append<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>token_ids<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        all_pred_positions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>pred_positions <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            max_num_mlm_preds <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pred_positions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token comment"># å¡«å……è¯å…ƒçš„é¢„æµ‹å°†é€šè¿‡ä¹˜ä»¥ 0 æƒé‡åœ¨æŸå¤±ä¸­è¿‡æ»¤æ‰</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        all_mlm_weights<span class="token punctuation">.</span>append<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>mlm_pred_label_ids<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                max_num_mlm_preds <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pred_positions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        all_mlm_labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>mlm_pred_label_ids <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            max_num_mlm_preds <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>mlm_pred_label_ids<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        nsp_labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>is_next<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span>all_token_ids<span class="token punctuation">,</span> all_segments<span class="token punctuation">,</span> valid_lens<span class="token punctuation">,</span> all_pred_positions<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            all_mlm_weights<span class="token punctuation">,</span> all_mlm_labels<span class="token punctuation">,</span> nsp_labels<span class="token punctuation">)</span></pre></td></tr></table></figure><p>å°†ç”¨äºç”Ÿæˆä¸¤ä¸ªé¢„è®­ç»ƒä»»åŠ¡çš„è®­ç»ƒæ ·æœ¬çš„è¾…åŠ©å‡½æ•°å’Œç”¨äºå¡«å……è¾“å…¥çš„è¾…åŠ©å‡½æ•°æ”¾åœ¨ä¸€èµ·ï¼Œæˆ‘ä»¬å®šä¹‰ä»¥ä¸‹ <code>_WikiTextDataset</code> ç±»ä¸ºç”¨äºé¢„è®­ç»ƒ BERT çš„ WikiText-2 æ•°æ®é›†ã€‚é€šè¿‡å®ç° <code>__getitem__</code> å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä»»æ„è®¿é—® WikiText-2 è¯­æ–™åº“çš„ä¸€å¯¹å¥å­ç”Ÿæˆçš„é¢„è®­ç»ƒæ ·æœ¬ï¼ˆé®è”½è¯­è¨€æ¨¡å‹å’Œä¸‹ä¸€å¥é¢„æµ‹ï¼‰æ ·æœ¬ã€‚</p><p>æœ€åˆçš„ BERT æ¨¡å‹ä½¿ç”¨è¯è¡¨å¤§å°ä¸º 30000 çš„ WordPiece åµŒå…¥ :cite: <code>Wu.Schuster.Chen.ea.2016</code> ã€‚WordPiece çš„è¯å…ƒåŒ–æ–¹æ³•æ˜¯å¯¹ :numref: <code>subsec_Byte_Pair_Encoding</code> ä¸­åŸæœ‰çš„å­—èŠ‚å¯¹ç¼–ç ç®—æ³•ç¨ä½œä¿®æ”¹ã€‚ä¸ºç®€å•èµ·è§ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>d2l.tokenize</code> å‡½æ•°è¿›è¡Œè¯å…ƒåŒ–ã€‚å‡ºç°æ¬¡æ•°å°‘äº 5 æ¬¡çš„ä¸é¢‘ç¹è¯å…ƒå°†è¢«è¿‡æ»¤æ‰ã€‚</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#@save</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">_WikiTextDataset</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> paragraphs<span class="token punctuation">,</span> max_len<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token comment"># è¾“å…¥ paragraphs [i] æ˜¯ä»£è¡¨æ®µè½çš„å¥å­å­—ç¬¦ä¸²åˆ—è¡¨ï¼›</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token comment"># è€Œè¾“å‡º paragraphs [i] æ˜¯ä»£è¡¨æ®µè½çš„å¥å­åˆ—è¡¨ï¼Œå…¶ä¸­æ¯ä¸ªå¥å­éƒ½æ˜¯è¯å…ƒåˆ—è¡¨</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        paragraphs <span class="token operator">=</span> <span class="token punctuation">[</span>d2l<span class="token punctuation">.</span>tokenize<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            paragraph<span class="token punctuation">,</span> token<span class="token operator">=</span><span class="token string">'word'</span><span class="token punctuation">)</span> <span class="token keyword">for</span> paragraph <span class="token keyword">in</span> paragraphs<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        sentences <span class="token operator">=</span> <span class="token punctuation">[</span>sentence <span class="token keyword">for</span> paragraph <span class="token keyword">in</span> paragraphs</pre></td></tr><tr><td data-num="9"></td><td><pre>                     <span class="token keyword">for</span> sentence <span class="token keyword">in</span> paragraph<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        self<span class="token punctuation">.</span>vocab <span class="token operator">=</span> d2l<span class="token punctuation">.</span>Vocab<span class="token punctuation">(</span>sentences<span class="token punctuation">,</span> min_freq<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> reserved_tokens<span class="token operator">=</span><span class="token punctuation">[</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token string">'&lt;pad>'</span><span class="token punctuation">,</span> <span class="token string">'&lt;mask>'</span><span class="token punctuation">,</span> <span class="token string">'&lt;cls>'</span><span class="token punctuation">,</span> <span class="token string">'&lt;sep>'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token comment"># è·å–ä¸‹ä¸€å¥å­é¢„æµ‹ä»»åŠ¡çš„æ•°æ®</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        examples <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">for</span> paragraph <span class="token keyword">in</span> paragraphs<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            examples<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>_get_nsp_data_from_paragraph<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                paragraph<span class="token punctuation">,</span> paragraphs<span class="token punctuation">,</span> self<span class="token punctuation">.</span>vocab<span class="token punctuation">,</span> max_len<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token comment"># è·å–é®è”½è¯­è¨€æ¨¡å‹ä»»åŠ¡çš„æ•°æ®</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        examples <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>_get_mlm_data_from_tokens<span class="token punctuation">(</span>tokens<span class="token punctuation">,</span> self<span class="token punctuation">.</span>vocab<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                      <span class="token operator">+</span> <span class="token punctuation">(</span>segments<span class="token punctuation">,</span> is_next<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                     <span class="token keyword">for</span> tokens<span class="token punctuation">,</span> segments<span class="token punctuation">,</span> is_next <span class="token keyword">in</span> examples<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token comment"># å¡«å……è¾“å…¥</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">(</span>self<span class="token punctuation">.</span>all_token_ids<span class="token punctuation">,</span> self<span class="token punctuation">.</span>all_segments<span class="token punctuation">,</span> self<span class="token punctuation">.</span>valid_lens<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>         self<span class="token punctuation">.</span>all_pred_positions<span class="token punctuation">,</span> self<span class="token punctuation">.</span>all_mlm_weights<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>         self<span class="token punctuation">.</span>all_mlm_labels<span class="token punctuation">,</span> self<span class="token punctuation">.</span>nsp_labels<span class="token punctuation">)</span> <span class="token operator">=</span> _pad_bert_inputs<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            examples<span class="token punctuation">,</span> max_len<span class="token punctuation">,</span> self<span class="token punctuation">.</span>vocab<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">return</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>all_token_ids<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>all_segments<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                self<span class="token punctuation">.</span>valid_lens<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>all_pred_positions<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                self<span class="token punctuation">.</span>all_mlm_weights<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>all_mlm_labels<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                self<span class="token punctuation">.</span>nsp_labels<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>all_token_ids<span class="token punctuation">)</span></pre></td></tr></table></figure><p>é€šè¿‡ä½¿ç”¨ <code>_read_wiki</code> å‡½æ•°å’Œ <code>_WikiTextDataset</code> ç±»ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸‹é¢çš„ <code>load_data_wiki</code> æ¥ä¸‹è½½å¹¶ç”Ÿæˆ WikiText-2 æ•°æ®é›†ï¼Œå¹¶ä»ä¸­ç”Ÿæˆé¢„è®­ç»ƒæ ·æœ¬ã€‚</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#@save</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">def</span> <span class="token function">load_data_wiki</span><span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> max_len<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token triple-quoted-string string">"""åŠ è½½WikiText-2æ•°æ®é›†"""</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    num_workers <span class="token operator">=</span> d2l<span class="token punctuation">.</span>get_dataloader_workers<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    data_dir <span class="token operator">=</span> d2l<span class="token punctuation">.</span>download_extract<span class="token punctuation">(</span><span class="token string">'wikitext-2'</span><span class="token punctuation">,</span> <span class="token string">'wikitext-2'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    paragraphs <span class="token operator">=</span> _read_wiki<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    train_set <span class="token operator">=</span> _WikiTextDataset<span class="token punctuation">(</span>paragraphs<span class="token punctuation">,</span> max_len<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    train_iter <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>train_set<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                                        shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> num_workers<span class="token operator">=</span>num_workers<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">return</span> train_iter<span class="token punctuation">,</span> train_set<span class="token punctuation">.</span>vocab</pre></td></tr></table></figure><p>å°†æ‰¹é‡å¤§å°è®¾ç½®ä¸º 512ï¼Œå°† BERT è¾“å…¥åºåˆ—çš„æœ€å¤§é•¿åº¦è®¾ç½®ä¸º 64ï¼Œæˆ‘ä»¬æ‰“å°å‡ºå°æ‰¹é‡çš„ BERT é¢„è®­ç»ƒæ ·æœ¬çš„å½¢çŠ¶ã€‚æ³¨æ„ï¼Œåœ¨æ¯ä¸ª BERT è¾“å…¥åºåˆ—ä¸­ï¼Œä¸ºé®è”½è¯­è¨€æ¨¡å‹ä»»åŠ¡é¢„æµ‹<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn></mrow><annotation encoding="application/x-tex">10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">1</span><span class="mord">0</span></span></span></span>ï¼ˆ<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>64</mn><mo>Ã—</mo><mn>0.15</mn></mrow><annotation encoding="application/x-tex">64 \times 0.15</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.72777em;vertical-align:-.08333em"></span><span class="mord">6</span><span class="mord">4</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span><span class="mord">5</span></span></span></span>ï¼‰ä¸ªä½ç½®ã€‚</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>batch_size<span class="token punctuation">,</span> max_len <span class="token operator">=</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">64</span></pre></td></tr><tr><td data-num="2"></td><td><pre>train_iter<span class="token punctuation">,</span> vocab <span class="token operator">=</span> load_data_wiki<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> max_len<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">for</span> <span class="token punctuation">(</span>tokens_X<span class="token punctuation">,</span> segments_X<span class="token punctuation">,</span> valid_lens_x<span class="token punctuation">,</span> pred_positions_X<span class="token punctuation">,</span> mlm_weights_X<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>     mlm_Y<span class="token punctuation">,</span> nsp_y<span class="token punctuation">)</span> <span class="token keyword">in</span> train_iter<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>tokens_X<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> segments_X<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> valid_lens_x<span class="token punctuation">.</span>shape<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>          pred_positions_X<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> mlm_weights_X<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> mlm_Y<span class="token punctuation">.</span>shape<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>          nsp_y<span class="token punctuation">.</span>shape<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">break</span></pre></td></tr></table></figure><pre><code>torch.Size([512, 64]) torch.Size([512, 64]) torch.Size([512]) torch.Size([512, 10]) torch.Size([512, 10]) torch.Size([512, 10]) torch.Size([512])
</code></pre><p>æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¯é‡ã€‚å³ä½¿åœ¨è¿‡æ»¤æ‰ä¸é¢‘ç¹çš„è¯å…ƒä¹‹åï¼Œå®ƒä»ç„¶æ¯” PTB æ•°æ®é›†çš„å¤§ä¸¤å€ä»¥ä¸Šã€‚</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token builtin">len</span><span class="token punctuation">(</span>vocab<span class="token punctuation">)</span></pre></td></tr></table></figure><pre><code>20256
</code></pre><h2 id="å°ç»“"><a class="anchor" href="#å°ç»“">#</a> å°ç»“</h2><ul><li>ä¸ PTB æ•°æ®é›†ç›¸æ¯”ï¼ŒWikiText-2 æ•°æ®é›†ä¿ç•™äº†åŸæ¥çš„æ ‡ç‚¹ç¬¦å·ã€å¤§å°å†™å’Œæ•°å­—ï¼Œå¹¶ä¸”æ¯” PTB æ•°æ®é›†å¤§äº†ä¸¤å€å¤šã€‚</li><li>æˆ‘ä»¬å¯ä»¥ä»»æ„è®¿é—®ä» WikiText-2 è¯­æ–™åº“ä¸­çš„ä¸€å¯¹å¥å­ç”Ÿæˆçš„é¢„è®­ç»ƒï¼ˆé®è”½è¯­è¨€æ¨¡å‹å’Œä¸‹ä¸€å¥é¢„æµ‹ï¼‰æ ·æœ¬ã€‚</li></ul><h2 id="ç»ƒä¹ "><a class="anchor" href="#ç»ƒä¹ ">#</a> ç»ƒä¹ </h2><ol><li>ä¸ºç®€å•èµ·è§ï¼Œå¥å·ç”¨ä½œæ‹†åˆ†å¥å­çš„å”¯ä¸€åˆ†éš”ç¬¦ã€‚å°è¯•å…¶ä»–çš„å¥å­æ‹†åˆ†æŠ€æœ¯ï¼Œæ¯”å¦‚ Spacy å’Œ NLTKã€‚ä»¥ NLTK ä¸ºä¾‹ï¼Œéœ€è¦å…ˆå®‰è£… NLTKï¼š <code>pip install nltk</code> ã€‚åœ¨ä»£ç ä¸­å…ˆ <code>import nltk</code> ã€‚ç„¶åä¸‹è½½ Punkt è¯­å¥è¯å…ƒåˆ†æå™¨ï¼š <code>nltk.download('punkt')</code> ã€‚è¦æ‹†åˆ†å¥å­ï¼Œæ¯”å¦‚ <code>sentences = 'This is great ! Why not ?'</code> ï¼Œè°ƒç”¨ <code>nltk.tokenize.sent_tokenize(sentences)</code> å°†è¿”å›ä¸¤ä¸ªå¥å­å­—ç¬¦ä¸²çš„åˆ—è¡¨ï¼š <code>['This is great !', 'Why not ?']</code> ã€‚</li><li>å¦‚æœæˆ‘ä»¬ä¸è¿‡æ»¤å‡ºä¸€äº›ä¸å¸¸è§çš„è¯å…ƒï¼Œè¯é‡ä¼šæœ‰å¤šå¤§ï¼Ÿ</li></ol><p><span class="exturl" data-url="aHR0cHM6Ly9kaXNjdXNzLmQybC5haS90LzU3Mzg=">Discussions</span></p><div class="tags"><a href="/tags/chapter-natural-language-processing-pretraining/" rel="tag"><i class="ic i-tag"></i> chapter_natural-language-processing-pretraining</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">æ›´æ–°äº</span> <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-03-04 13:38:25" itemprop="dateModified" datetime="2023-03-04T13:38:25+08:00">2023-03-04</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> èµèµ</button><p>è¯·æˆ‘å–[èŒ¶]~(ï¿£â–½ï¿£)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="yuan å¾®ä¿¡æ”¯ä»˜"><p>å¾®ä¿¡æ”¯ä»˜</p></div><div><img data-src="/images/alipay.png" alt="yuan æ”¯ä»˜å®"><p>æ”¯ä»˜å®</p></div><div><img data-src="/images/paypal.png" alt="yuan è´å®"><p>è´å®</p></div></div></div><div id="copyright"><ul><li class="author"><strong>æœ¬æ–‡ä½œè€…ï¼š </strong>yuan <i class="ic i-at"><em>@</em></i>yuan</li><li class="link"><strong>æœ¬æ–‡é“¾æ¥ï¼š</strong> <a href="https://huang-junyuan.github.io/2023/02/15/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter_natural-language-processing-pretraining/bert-dataset/" title="bert-dataset">https://huang-junyuan.github.io/2023/02/15/ai/pytorchæ·±åº¦å­¦ä¹ /chapter_natural-language-processing-pretraining/bert-dataset/</a></li><li class="license"><strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬ç«™æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2023/02/15/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter_natural-language-processing-pretraining/approx-training/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;gitee.com&#x2F;zkz0&#x2F;image&#x2F;raw&#x2F;master&#x2F;img&#x2F;img(98).webp" title="approx-training"><span class="type">ä¸Šä¸€ç¯‡</span> <span class="category"><i class="ic i-flag"></i> chapter_natural-language-processing-pretraining</span><h3>approx-training</h3></a></div><div class="item right"><a href="/2023/02/15/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter_linear-networks/softmax-regression/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;gitee.com&#x2F;zkz0&#x2F;image&#x2F;raw&#x2F;master&#x2F;img&#x2F;img(35).webp" title="softmax-regression"><span class="type">ä¸‹ä¸€ç¯‡</span> <span class="category"><i class="ic i-flag"></i> chapter_linear-networks</span><h3>softmax-regression</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="æ–‡ç« ç›®å½•"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%A8%E4%BA%8E%E9%A2%84%E8%AE%AD%E7%BB%83bert%E7%9A%84%E6%95%B0%E6%8D%AE%E9%9B%86"><span class="toc-number">1.</span> <span class="toc-text">ç”¨äºé¢„è®­ç»ƒ BERT çš„æ•°æ®é›†</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E9%A2%84%E8%AE%AD%E7%BB%83%E4%BB%BB%E5%8A%A1%E5%AE%9A%E4%B9%89%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.</span> <span class="toc-text">ä¸ºé¢„è®­ç»ƒä»»åŠ¡å®šä¹‰è¾…åŠ©å‡½æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E4%B8%8B%E4%B8%80%E5%8F%A5%E9%A2%84%E6%B5%8B%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="toc-number">1.1.1.</span> <span class="toc-text">ç”Ÿæˆä¸‹ä¸€å¥é¢„æµ‹ä»»åŠ¡çš„æ•°æ®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E9%81%AE%E8%94%BD%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="toc-number">1.1.2.</span> <span class="toc-text">ç”Ÿæˆé®è”½è¯­è¨€æ¨¡å‹ä»»åŠ¡çš„æ•°æ®</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86%E6%96%87%E6%9C%AC%E8%BD%AC%E6%8D%A2%E4%B8%BA%E9%A2%84%E8%AE%AD%E7%BB%83%E6%95%B0%E6%8D%AE%E9%9B%86"><span class="toc-number">1.2.</span> <span class="toc-text">å°†æ–‡æœ¬è½¬æ¢ä¸ºé¢„è®­ç»ƒæ•°æ®é›†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">1.3.</span> <span class="toc-text">å°ç»“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0"><span class="toc-number">1.4.</span> <span class="toc-text">ç»ƒä¹ </span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="ç³»åˆ—æ–‡ç« "><ul><li class="active"><a href="/2023/02/15/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter_natural-language-processing-pretraining/bert-dataset/" rel="bookmark" title="bert-dataset">bert-dataset</a></li><li><a href="/2023/02/15/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter_natural-language-processing-pretraining/approx-training/" rel="bookmark" title="approx-training">approx-training</a></li><li><a href="/2023/02/15/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter_natural-language-processing-pretraining/bert-pretraining/" rel="bookmark" title="bert-pretraining">bert-pretraining</a></li><li><a href="/2023/02/15/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter_natural-language-processing-pretraining/glove/" rel="bookmark" title="glove">glove</a></li><li><a href="/2023/02/15/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter_natural-language-processing-pretraining/bert/" rel="bookmark" title="bert">bert</a></li><li><a href="/2023/02/15/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter_natural-language-processing-pretraining/index/" rel="bookmark" title="index">index</a></li><li><a href="/2023/02/15/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter_natural-language-processing-pretraining/similarity-analogy/" rel="bookmark" title="similarity-analogy">similarity-analogy</a></li><li><a href="/2023/02/15/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter_natural-language-processing-pretraining/word-embedding-dataset/" rel="bookmark" title="word-embedding-dataset">word-embedding-dataset</a></li><li><a href="/2023/02/15/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter_natural-language-processing-pretraining/word2vec/" rel="bookmark" title="word2vec">word2vec</a></li><li><a href="/2023/02/15/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter_natural-language-processing-pretraining/subword-embedding/" rel="bookmark" title="subword-embedding">subword-embedding</a></li><li><a href="/2023/02/15/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter_natural-language-processing-pretraining/word2vec-pretraining/" rel="bookmark" title="word2vec-pretraining">word2vec-pretraining</a></li></ul></div><div class="overview panel" data-title="ç«™ç‚¹æ¦‚è§ˆ"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="yuan" data-src="/images/avatar.jpg"><p class="name" itemprop="name">yuan</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">409</span> <span class="name">æ–‡ç« </span></a></div><div class="item categories"><a href="/categories/"><span class="count">72</span> <span class="name">åˆ†ç±»</span></a></div><div class="item tags"><a href="/tags/"><span class="count">61</span> <span class="name">æ ‡ç­¾</span></a></div></nav><div class="social"><span class="exturl item email" data-url="bWFpbHRvOjIwODM2MzU1MjVAcXEuY29t" title="mailto:2083635525@qq.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>é¦–é¡µ</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>å…³äº</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>æ–‡ç« </a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>å½’æ¡£</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>åˆ†ç±»</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>æ ‡ç­¾</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>å‹é”</a></li><li class="item"><a href="/links/" rel="section"><i class="ic i-magic"></i>é“¾æ¥</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2023/02/15/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter_natural-language-processing-pretraining/approx-training/" rel="prev" title="ä¸Šä¸€ç¯‡"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2023/02/15/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter_linear-networks/softmax-regression/" rel="next" title="ä¸‹ä¸€ç¯‡"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>éšæœºæ–‡ç« </h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/ai/" title="åˆ†ç±»äº ai">ai</a> <i class="ic i-angle-right"></i> <a href="/categories/ai/nlp/" title="åˆ†ç±»äº nlp">nlp</a> <i class="ic i-angle-right"></i> <a href="/categories/ai/nlp/huggingface/" title="åˆ†ç±»äº huggingface">huggingface</a> <i class="ic i-angle-right"></i> <a href="/categories/ai/nlp/huggingface/Tokenizer%E5%BA%93/" title="åˆ†ç±»äº Tokenizeråº“">Tokenizeråº“</a></div><span><a href="/2022/11/12/ai/nlp/huggingface/Tokenizers%E5%BA%93/Unigram%E6%A0%87%E8%AE%B0%E5%8C%96/" title="Unigram">Unigram</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E8%BD%AF%E5%B7%A5/" title="åˆ†ç±»äº è½¯å·¥">è½¯å·¥</a></div><span><a href="/2022/09/19/computer-science/base/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/%E6%95%B4%E4%BD%93%E8%AE%BE%E8%AE%A1/" title="æ•´ä½“è®¾è®¡--è½¯å·¥">æ•´ä½“è®¾è®¡--è½¯å·¥</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ai/" title="åˆ†ç±»äº ai">ai</a> <i class="ic i-angle-right"></i> <a href="/categories/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" title="åˆ†ç±»äº pytorchæ·±åº¦å­¦ä¹ ">pytorchæ·±åº¦å­¦ä¹ </a> <i class="ic i-angle-right"></i> <a href="/categories/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter-computer-vision/" title="åˆ†ç±»äº chapter_computer-vision">chapter_computer-vision</a></div><span><a href="/2023/02/15/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter_computer-vision/semantic-segmentation-and-dataset/" title="semantic-segmentation-and-dataset">semantic-segmentation-and-dataset</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ai/" title="åˆ†ç±»äº ai">ai</a> <i class="ic i-angle-right"></i> <a href="/categories/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" title="åˆ†ç±»äº pytorchæ·±åº¦å­¦ä¹ ">pytorchæ·±åº¦å­¦ä¹ </a> <i class="ic i-angle-right"></i> <a href="/categories/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter-preliminaries/" title="åˆ†ç±»äº chapter_preliminaries">chapter_preliminaries</a></div><span><a href="/2023/02/15/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter_preliminaries/index/" title="index">index</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" title="åˆ†ç±»äº è®¡ç®—æœºç§‘å­¦">è®¡ç®—æœºç§‘å­¦</a> <i class="ic i-angle-right"></i> <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/csp/" title="åˆ†ç±»äº csp">csp</a></div><span><a href="/2022/08/24/computer-science/algorithm/csp/2%E9%A2%98/202203-2-%E5%87%BA%E8%A1%8C%E8%AE%A1%E5%88%92/" title="202203-2-å‡ºè¡Œè®¡åˆ’">202203-2-å‡ºè¡Œè®¡åˆ’</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/frontend/" title="åˆ†ç±»äº å‰ç«¯">å‰ç«¯</a></div><span><a href="/2022/08/09/frontend/base/TypeScript/" title="TypeScript">TypeScript</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ai/" title="åˆ†ç±»äº ai">ai</a> <i class="ic i-angle-right"></i> <a href="/categories/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" title="åˆ†ç±»äº pytorchæ·±åº¦å­¦ä¹ ">pytorchæ·±åº¦å­¦ä¹ </a> <i class="ic i-angle-right"></i> <a href="/categories/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter-computational-performance/" title="åˆ†ç±»äº chapter_computational-performance">chapter_computational-performance</a></div><span><a href="/2023/02/15/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter_computational-performance/multiple-gpus-concise/" title="multiple-gpus-concise">multiple-gpus-concise</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2022/08/25/language/vbs/vbs/" title="vbs">vbs</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="åˆ†ç±»äº computer-science">computer-science</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/algorithm/" title="åˆ†ç±»äº algorithm">algorithm</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/algorithm/leetCode/" title="åˆ†ç±»äº leetCode">leetCode</a></div><span><a href="/2022/12/26/computer-science/algorithm/leetCode/11-%E5%A6%99%E7%94%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" title="11-å¦™ç”¨æ•°æ®ç»“æ„">11-å¦™ç”¨æ•°æ®ç»“æ„</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ai/" title="åˆ†ç±»äº ai">ai</a> <i class="ic i-angle-right"></i> <a href="/categories/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" title="åˆ†ç±»äº pytorchæ·±åº¦å­¦ä¹ ">pytorchæ·±åº¦å­¦ä¹ </a> <i class="ic i-angle-right"></i> <a href="/categories/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter-linear-networks/" title="åˆ†ç±»äº chapter_linear-networks">chapter_linear-networks</a></div><span><a href="/2023/02/15/ai/pytorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/chapter_linear-networks/image-classification-dataset/" title="image-classification-dataset">image-classification-dataset</a></span></li></ul></div><div><h2>æœ€æ–°è¯„è®º</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 â€“ <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">yuan @ Mi Manchi</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="ç«™ç‚¹æ€»å­—æ•°">2.9m å­—</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">43:40</span></div><div class="powered-by">åŸºäº <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2023/02/15/ai/pytorchæ·±åº¦å­¦ä¹ /chapter_natural-language-processing-pretraining/bert-dataset/",favicon:{show:"ï¼ˆâ—Â´3ï½€â—ï¼‰ã‚„ã‚Œã‚„ã‚Œã ãœ",hide:"(Â´Ğ”ï½€)å¤§å¤‰ã ï¼"},search:{placeholder:"æ–‡ç« æœç´¢",empty:"å…³äº ã€Œ ${query} ã€ï¼Œä»€ä¹ˆä¹Ÿæ²¡æœåˆ°",stats:"${time} ms å†…æ‰¾åˆ° ${hits} æ¡ç»“æœ"},valine:!0,copy_tex:!0,katex:!0,fancybox:!0,copyright:'å¤åˆ¶æˆåŠŸï¼Œè½¬è½½è¯·éµå®ˆ <i class="ic i-creative-commons"></i>BY-NC-SA åè®®ã€‚',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>